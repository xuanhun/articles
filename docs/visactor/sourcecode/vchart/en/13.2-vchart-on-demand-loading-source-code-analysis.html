<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>13.2 VChart On-Demand Loading Source Code Explanation</title>
    <meta name="keywords" content="VisActor,VChart,VTable,VStrory,VMind,VGrammar,VRender,Visualization,Chart,Data,Table,Graph,Gis,LLM">
    <style>
        body {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            color: #24292e;
            background-color: #fff;
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }
        h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h3 { font-size: 1.25em; }
        code {
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }
        pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 6px;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            font-size: 100%;
        }
        img {
            max-width: 100%;
            height: auto;
            box-sizing: content-box;
            background-color: #fff;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            display: block;
            overflow: auto;
        }
        table th, table td {
            padding: 6px 13px;
            border: 1px solid #d0d7de;
        }
        table th {
            font-weight: 600;
            background-color: #f6f8fa;
        }
        table tr {
            background-color: #fff;
            border-top: 1px solid #d0d7de;
        }
        table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }
        a {
            color: #0969da;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            padding: 0 1em;
            color: #656d76;
            border-left: 0.25em solid #d0d7de;
            margin: 0 0 16px 0;
        }
        hr {
            height: 0.25em;
            padding: 0;
            margin: 24px 0;
            background-color: #d0d7de;
            border: 0;
        }
        ul, ol {
            padding-left: 2em;
        }
        li + li {
            margin-top: 0.25em;
        }
    </style>
</head>
<body>
    <p>Based on the previous articles, we have introduced the composition of VChart and the concept of Tree Shaking. Based on these two preliminary concepts, we will now elaborate on the specific implementation of VChart's on-demand loading.    </p>
<h2 id="core-creation-process-of-vchart-charts">Core Creation Process of VChart Charts</h2>
<p><img alt="" src="https://cdn.jsdelivr.net/gh/xuanhun/articles/visactor/sourcecode/img/OPhHwelczhjcCBb4zlQcbTIDnzh.gif" /></p>
<h2 id="factory">Factory</h2>
<p>The on-demand loading of VChart mainly relies on the <code>Factory</code> class to achieve this. This class plays an important role, responsible for registering and creating various charts, series, components, graphics, Regions, layouts, and plugins. Below, we will conduct an in-depth analysis from the aspects of the registration mechanism, creation mechanism, and on-demand registration of charts.</p>
<h3 id="registration-mechanism">Registration Mechanism</h3>
<p>The <code>Factory</code> class provides a series of static methods for registering different types of modules. Through these methods, modules are registered into the static properties of <code>Factory</code>, thereby forming a registry. The specific code is as follows:</p>
<pre class="codehilite"><code class="language-xml">static registerChart(key: string, chart: IChartConstructor) {
  Factory._charts[key] = chart;
}
static registerSeries(key: string, series: ISeriesConstructor) {
  Factory._series[key] = series;
}
static registerComponent(key: string, cmp: IComponentConstructor, alwaysCheck?: boolean) {
  Factory._components[key] = { cmp, alwaysCheck };
}
// 其他注册方法...    
</code></pre>

<h3 id="creation-mechanism">Creation Mechanism</h3>
<p>The <code>Factory</code> class also provides a series of static methods for creating module instances as needed. These methods look up the corresponding constructor from the registry based on the type and create an instance. The sample code is as follows:</p>
<pre class="codehilite"><code class="language-xml">static createChart(chartType: string, spec: any, options: IChartOption): IChart | null {
  if (!Factory._charts[chartType]) {
    return null;
  }
  const ChartConstructor = Factory._charts[chartType];
  return new ChartConstructor(spec, options);
}
static createSeries(seriesType: string, spec: any, options: ISeriesOption) {
  if (!Factory._series[seriesType]) {
    return null;
  }
  const SeriesConstructor = Factory._series[seriesType];
  return new SeriesConstructor(spec, options);
}
// 其他创建方法...    
</code></pre>

<h3 id="on-demand-registration-of-charts">On-Demand Registration of Charts</h3>
<p>Taking the line chart as an example, let's look at the specific implementation of on-demand registration. In <code>packages/vchart/src/chart/line/line.ts</code>, there is the following code:</p>
<pre class="codehilite"><code class="language-javascript">export const registerLineChart = () =&gt; {
  registerLineSeries();
  Factory.registerChart(LineChart.type, LineChart);
};    
</code></pre>

<p>The <code>registerLineSeries</code> is implemented in <code>packages/vchart/src/series/line/line.ts</code>, the code is as follows:    </p>
<pre class="codehilite"><code class="language-javascript">export const registerLineSeries = () =&gt; {
  registerSampleTransform();
  registerMarkOverlapTransform();
  registerLineMark();
  registerSymbolMark();
  registerLineAnimation();
  registerScaleInOutAnimation();
  registerCartesianBandAxis();
  registerCartesianLinearAxis();
  Factory.registerSeries(LineSeries.type, LineSeries);
};    
</code></pre>

<p>By implementing the above code, when using VChart, if you call <code>registerLineChart</code> to register a line chart, it will automatically register the necessary elements such as the line series, line chart elements, and point chart elements that the line chart depends on. The specific usage is as follows:</p>
<pre class="codehilite"><code class="language-xml">import { VChart } from './core';
import { registerLineChart } from './chart/line';
VChart.useRegisters([
  registerLineChart,
  // 其他需要的模块
]);    
</code></pre>

<p>In <code>packages/vchart/src/core/vchart.ts</code>, the chart instance is not created by direct path reference, but by using <code>Factory.createChart</code>. In this way, the core class <code>vchart</code> can create instances based on the charts registered by the user without referencing all chart implementations. The relevant code is as follows:    </p>
<pre class="codehilite"><code class="language-xml">private _initChart(spec: any) {
   // ...
    const chart = Factory.createChart(spec.type, spec, this._getChartOption(spec.type));
   //...
  }    
</code></pre>

<h2 id="core-class-vchart-on-demand-loading">Core Class VChart On-Demand Loading</h2>
<p>Next, let's discuss a question: Is there a difference between the following two ways of referencing <code>VChart</code>?</p>
<ul>
<li>Method One:</li>
</ul>
<pre class="codehilite"><code class="language-javascript">import VChart from '@visactor/vchart';    
</code></pre>

<ul>
<li>Method Two:    </li>
</ul>
<pre class="codehilite"><code class="language-javascript">import { VChart } from '@visactor/vchart';    
</code></pre>

<p>The answer is yes, the effects produced by these two citation methods are different. Below is an analysis of the reasons for their differences.    </p>
<p>First, in the corresponding <code>package.json</code> of the vchart codebase, you can see the following configuration:    </p>
<pre class="codehilite"><code class="language-xml">{
  &quot;sideEffects&quot;: [
    &quot;./*/index-lark.js&quot;,
    &quot;./*/index-wx-simple.js&quot;,
    &quot;./*/index-wx.js&quot;,
    &quot;./*/vchart-all.js&quot;,
    &quot;./*/vchart-simple.js&quot;
  ],
}    
</code></pre>

<p>The configuration explicitly declares all files with side effects.    </p>
<p>In <code>packages/vchart/index.ts</code>, the following exports are present:    </p>
<pre class="codehilite"><code class="language-xml">import { VChart } from './vchart-all';
export default VChart;
export * from './core';    
</code></pre>

<p>In the <code>core/index.ts</code> file, the following exports are present:    </p>
<pre class="codehilite"><code class="language-javascript">import { VChart } from './vchart';
export { VChart, Factory };    
</code></pre>

<p>So method one is equivalent to the following reference, where the referenced VChart is the VChart class exported by vchart-all, and method two is equivalent to the VChart class exported from <code>core/vchart.ts</code>.    </p>
<pre class="codehilite"><code class="language-json">import { default as VChart } from '@visactor/vchart';    
</code></pre>

<p>The main purpose of the file <code>vchart-all.ts</code> is to register and export all functional modules of VChart:</p>
<pre class="codehilite"><code class="language-json">VChart.useRegisters([
  // charts
  registerLineChart,
  registerAreaChart,
  // ...其他图表
  // components
  registerCartesianLinearAxis,
  registerCartesianBandAxis,
  // ...其他组件
  // layout
  registerGridLayout,
  registerLayout3d,
  // mark
  registerAllMarks,
  // plugin
  registerDomTooltipHandler,
  registerCanvasTooltipHandler,
  // ...其他插件
]);
export { VChart };    
</code></pre>

<p>Since vchart - all is declared as a file with side effects, when VChart is referenced using method one, all files that vchart-all depends on will be packaged; whereas when VChart is referenced using method two, only core/vchart.ts will be packaged.</p>
<h1 id="this-document-was-revised-and-organized-by-the-following-personnel">This document was revised and organized by the following personnel</h1>
<p><a href="https://github.com/xuanhun">玄魂</a></p>
</body>
</html>