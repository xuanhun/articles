<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1 VChart 基本原理</title>
    <meta name="keywords" content="VisActor,VChart,VTable,VStrory,VMind,VGrammar,VRender,Visualization,Chart,Data,Table,Graph,Gis,LLM">
    <style>
        body {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            color: #24292e;
            background-color: #fff;
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }
        h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h3 { font-size: 1.25em; }
        code {
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }
        pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 6px;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            font-size: 100%;
        }
        img {
            max-width: 100%;
            height: auto;
            box-sizing: content-box;
            background-color: #fff;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            display: block;
            overflow: auto;
        }
        table th, table td {
            padding: 6px 13px;
            border: 1px solid #d0d7de;
        }
        table th {
            font-weight: 600;
            background-color: #f6f8fa;
        }
        table tr {
            background-color: #fff;
            border-top: 1px solid #d0d7de;
        }
        table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }
        a {
            color: #0969da;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            padding: 0 1em;
            color: #656d76;
            border-left: 0.25em solid #d0d7de;
            margin: 0 0 16px 0;
        }
        hr {
            height: 0.25em;
            padding: 0;
            margin: 24px 0;
            background-color: #d0d7de;
            border: 0;
        }
        ul, ol {
            padding-left: 2em;
        }
        li + li {
            margin-top: 0.25em;
        }
    </style>
</head>
<body>
    <h1 id="11">1.1 图表组成</h1>
<h2 id="_1">术语</h2>
<ol>
<li>
<p>Mark：基本图形元素（基本图元），如线、点、矩形等    </p>
</li>
<li>
<p>Series：负责特定类型数据的可视化表达，包含一组图元及其对应的图表逻辑，比如折线图中的一系列线    </p>
</li>
<li>
<p>Region：定义图表的空间区域，关联一组或多组 series，处理交互和动画，提供坐标系统    </p>
</li>
<li>
<p>Component：组件，帮助图表阅读和交互的元素，如图例、坐标轴、提示等    </p>
</li>
<li>
<p>Layout：管理图表的布局，包括 region 和 component 的位置和大小    </p>
</li>
<li>
<p>Chart：整个图表的抽象概念，包含视图上的元素比如 layout，component 和 region，也包含数据等所有构成一个表格需要的元素    </p>
</li>
</ol>
<h2 id="_2">结构关系</h2>
<p><img src='https://cdn.jsdelivr.net/gh/xuanhun/articles/visactor/sourcecode/img/HOM9w48WrhyL5hbEByTcG0BanGf.gif' alt='' width='534' height='auto' /></p>
<h2 id="_3">简单图表例子</h2>
<p><img src='https://cdn.jsdelivr.net/gh/xuanhun/articles/visactor/sourcecode/img/S64ebNauBobOOJxwIalcq8E9ncf.gif' alt='' width='1000' height='auto' /></p>
<h2 id="_4">组合图表例子</h2>
<h3 id="region">同一个 Region</h3>
<p><img src='https://cdn.jsdelivr.net/gh/xuanhun/articles/visactor/sourcecode/img/GAGOb6NrBoGdMrxHbt9cvDXNndb.gif' alt='' width='1000' height='auto' /></p>
<p>上图是一个组合图，简单来说就是有多组 series，上面是 bar 和 line 这两组 series。    </p>
<ol>
<li>
<p>如果我们没有特别配置，所有 series 都会关联在一个 region，所以他们会重叠在一起，并且共享某些坐标    </p>
</li>
<li>
<p>每个系列可以有自己的数据源，也可以直接将数据源配置在 chart 上，series 中通过 <code>fromDataId</code> 或者 <code>fromDataIndex</code> 来关联，当前的例子我们选择配置在 chart 上    </p>
</li>
</ol>
<h3 id="region_1">不同 Region</h3>
<p><img src='https://cdn.jsdelivr.net/gh/xuanhun/articles/visactor/sourcecode/img/FdZebrNhWo3MqTxoqOfcAyYJnh6.gif' alt='' width='1000' height='auto' /></p>
<p>在这个例子中，也是一个组合图，但是他的两组 series 出现在了不同的 region。如上文所说，我们用 layout 管理 region 的布局，在这个例子中，我们使用了如下代码：    </p>
<pre class="codehilite"><code class="language-Typescript">  layout: {
    type: 'grid',
    col: 4,
    row: 3,
    elements: [
      {
        modelId: 'legend',
        col: 0,
        colSpan: 4,
        row: 0
      },
      {
        modelId: 'pie-region',
        col: 0,
        colSpan: 2,
        row: 1
      },
      {
        modelId: 'axis-left',
        col: 2,
        row: 1
      },
      {
        modelId: 'bar-region',
        col: 3,
        row: 1
      },
      {
        modelId: 'axis-bottom',
        col: 3,
        row: 2
      }
    ]
  },    
</code></pre>

<p>上面通过了类似于 grid 的方式来管理 region 和 component 的布局。我们使用这些 <code>modelId</code> 来关联对应 region 和 component 的配置：    </p>
<pre class="codehilite"><code class="language-Typescript">  region: [
    {
      id: 'pie-region'
    },
    {
      id: 'bar-region'
    }
  ],
  axes: [
    {
      id: 'axis-left',
      regionId: 'bar-region',
      orient: 'left'
    },
    {
      id: 'axis-bottom',
      regionId: 'bar-region',
      orient: 'bottom'
    }
  ]    
</code></pre>

<h1 id="12-vchart">1.2 VChart 架构与源码结构</h1>
<h2 id="121-vchart-vgrammar-vrender">1.2.1 VChart, VGrammar 和 VRender 的关系</h2>
<p>这三者是 VisActor 可视化系统中的三个核心组件，它们的关系是层次化的，从底层到上层分别是：    </p>
<h3 id="vrender">VRender（底层）</h3>
<p>VRender 是一个底层的可视化渲染引擎，负责最基本的图形绘制和渲染工作：    </p>
<ul>
<li>
<p>它提供了丰富的可视化渲染功能，包括自定义动画、元素组合和叙事排列    </p>
</li>
<li>
<p>它是 VisActor 可视化系统的基础，为上层库提供渲染能力    </p>
</li>
<li>
<p>VRender 提供插件系统，可以灵活扩展    </p>
</li>
<li>
<p>它可以在 2D/3D 效果之间无缝切换    </p>
</li>
<li>
<p>它负责底层的 Canvas 操作、图形绘制、场景管理等    </p>
</li>
</ul>
<h3 id="vgrammar">VGrammar（中层）</h3>
<p>VGrammar 是基于 VRender 的可视化语法库：    </p>
<ul>
<li>
<p>它使用声明式语法来描述数据可视化    </p>
</li>
<li>
<p>VGrammar 将数据与视觉元素映射起来，处理数据变换、标记、比例尺等    </p>
</li>
<li>
<p>它提供了更加高级的 API，简化了创建复杂可视化的过程    </p>
</li>
<li>
<p>VGrammar 负责图表的语法定义、数据映射、自动布局等    </p>
</li>
<li>
<p>它相当于是对 VRender 的进一步封装，增加了更多的可视化语法概念    </p>
</li>
</ul>
<h3 id="vchart">VChart（上层）</h3>
<p>VChart 是最上层的图表组件库：    </p>
<ul>
<li>
<p>它基于 VGrammar 构建，封装了常见的图表类型（柱状图、饼图、折线图等）    </p>
</li>
<li>
<p>VChart 提供了开箱即用的图表组件，用户不需要了解底层的图形语法    </p>
</li>
<li>
<p>它具有跨平台特性，能自动适配桌面、H5 和多种小程序环境    </p>
</li>
<li>
<p>VChart 提供了完整的数据叙事能力，包括全面的注释、动画、流程控制和叙事模板    </p>
</li>
<li>
<p>它面向最终用户，提供了最友好的可视化界面和 API    </p>
</li>
</ul>
<h3 id="_5">总结关系</h3>
<p>这三者的架构关系可以理解为：    </p>
<pre class="codehilite"><code class="language-Typescript">VChart (图表组件库)
   ↓
VGrammar (可视化语法)
   ↓
VRender (渲染引擎)
   ↓
浏览器/Canvas/WebGL    
</code></pre>

<p>从代码实现上看：    </p>
<ul>
<li>
<p>VChart 使用 VGrammar 来定义和构建图表    </p>
</li>
<li>
<p>VGrammar 使用 VRender 来进行实际的绘制和渲染    </p>
</li>
<li>
<p>最终，VRender 控制底层的 Canvas/WebGL 绘制图形    </p>
</li>
</ul>
<p>这种分层架构使得开发者可以根据需要选择不同层次的工具：如果需要高度自定义的可视化，可以直接使用 VRender 或 VGrammar；如果需要快速创建标准图表，则可以使用 VChart。    </p>
<h2 id="122-vchart">1.2.2 VChart 内部组件之间关系与源码结构</h2>
<p>整体架构采用了模块化设计，核心分为以下几个主要部分：    </p>
<ol>
<li>
<p>核心引擎 (Core): VChart 的中心控制器，负责组织各模块协同工作    </p>
</li>
<li>
<p>图表 (Chart): 各种图表类型的具体实现    </p>
</li>
<li>
<p>系列 (Series): 负责图表中数据到图形的映射    </p>
</li>
<li>
<p>标记 (Mark): 基础图形元素    </p>
</li>
<li>
<p>区域 (Region): 定义图表渲染的区域    </p>
</li>
<li>
<p>组件 (Component): 如坐标轴、图例等附加组件    </p>
</li>
<li>
<p>布局 (Layout): 处理图表各元素的位置计算    </p>
</li>
<li>
<p>事件 (Event): 处理用户交互    </p>
</li>
<li>
<p>缩放 (Scale): 数据映射和比例尺相关    </p>
</li>
<li>
<p>数据处理 (Data): 数据转换和处理    </p>
</li>
</ol>
<h3 id="_6">核心模块</h3>
<h4 id="vchart_1">VChart 核心类</h4>
<p>VChart 类是整个图表库的入口，它负责实例化和管理整个图表的生命周期。    </p>
<pre class="codehilite"><code class="language-Typescript">// packages/vchart/src/core/vchart.ts
export class VChart implements IVChart {
  readonly id = createID();

  // 用于注册图表、组件、系列等
  static useRegisters(comps: (() =&gt; void)[]) { ... }
  static useChart(charts: IChartConstructor[]) { ... }
  static useSeries(series: ISeriesConstructor[]) { ... }

  // 核心渲染流程
  renderSync(morphConfig?: IMorphConfig) { ... }
  async renderAsync(morphConfig?: IMorphConfig) { ... }

  // 数据更新方法
  updateData(id: StringOrNumber, data: DataView | Datum[] | string, ...) { ... }
  updateSpec(spec: ISpec, forceMerge: boolean = false, ...) { ... }

  // 状态管理
  setSelected(datum: MaybeArray&lt;any&gt; | null, ...) { ... }
  setHovered(datum: MaybeArray&lt;Datum&gt; | null, ...) { ... }
}    
</code></pre>

<p>VChart 的生命周期主要包括：    </p>
<ol>
<li>
<p>初始化配置与数据    </p>
</li>
<li>
<p>创建图表实例    </p>
</li>
<li>
<p>布局计算    </p>
</li>
<li>
<p>渲染    </p>
</li>
<li>
<p>交互事件处理    </p>
</li>
<li>
<p>更新与销毁    </p>
</li>
</ol>
<h4 id="chart">模块图表类 (Chart)</h4>
<p>图表模块实现了各种不同类型的图表，如柱状图、折线图、饼图等，都继承自 BaseChart。    </p>
<pre class="codehilite"><code class="language-Typescript">// packages/vchart/src/chart/base/base-chart.ts
export class BaseChart&lt;T extends IChartSpec&gt; extends CompilableBase implements IChart {
  readonly type: string = 'chart';
  readonly seriesType: string;

  protected _regions: IRegion[] = [];
  protected _series: ISeries[] = [];
  protected _components: IComponent[] = [];

  protected _layoutFunc: LayoutCallBack;
  protected _layoutRect: IRect = { ... };

  layout(params: ILayoutParams): void { ... }
  compile() { ... }
}    
</code></pre>

<p>比如 BarChart 继承自 BaseChart    </p>
<pre class="codehilite"><code class="language-Typescript">export class BarChart&lt;T extends IBarChartSpec = IBarChartSpec&gt; extends BaseChart&lt;T&gt; {
  static readonly type: string = ChartTypeEnum.bar;
  static readonly seriesType: string = SeriesTypeEnum.bar;
  static readonly transformerConstructor = BarChartSpecTransformer;
  readonly transformerConstructor = BarChartSpecTransformer;
  readonly type: string = ChartTypeEnum.bar;
  readonly seriesType: string = SeriesTypeEnum.bar;
}    
</code></pre>

<p>图表模块负责:    </p>
<ul>
<li>
<p>确定图表类型和布局    </p>
</li>
<li>
<p>管理包含的区域、系列和组件    </p>
</li>
<li>
<p>处理数据到视觉元素的整体映射    </p>
</li>
</ul>
<h4 id="series">系列模块 (Series)</h4>
<p>系列模块是数据到视觉表现的核心映射，不同的系列类型对应不同的图形表现形式。    </p>
<pre class="codehilite"><code class="language-Typescript">// packages/vchart/src/series/base/base-series.ts
export abstract class BaseSeries&lt;T extends ISeriesSpec&gt; extends BaseModel&lt;T&gt; implements ISeries {
  readonly type: string = 'series';
  readonly coordinate: CoordinateType = 'none';

  protected _region: IRegion;
  protected _rootMark: IGroupMark = null;
  protected _seriesMark: Maybe&lt;IMark&gt; = null;

  protected _rawData!: DataView;
  protected _data: SeriesData = null;

  abstract initMark(): void;
  abstract initMarkStyle(): void;
  abstract dataToPosition(data: Datum, checkInViewData?: boolean): IPoint;
}    
</code></pre>

<p>系列模块负责:    </p>
<ul>
<li>
<p>数据到图形标记的转换    </p>
</li>
<li>
<p>处理特定图表类型的数据映射    </p>
</li>
<li>
<p>管理标记的样式和状态    </p>
</li>
</ul>
<h4 id="mark">标记模块 (Mark)</h4>
<p>标记是最基础的视觉元素，如线、矩形、点等，它们是构成图表的基本单位。相对应的代码在 <code>packages/vchart/src/mark</code>目录下有各种标记实现    </p>
<p>标记负责:    </p>
<ul>
<li>
<p>实现具体的图形渲染    </p>
</li>
<li>
<p>处理交互状态（如高亮、选中）    </p>
</li>
<li>
<p>与数据进行绑定    </p>
</li>
</ul>
<h4 id="region_2">区域模块 (Region)</h4>
<p>区域定义了图表在画布中的渲染位置，可以包含多个系列。对应代码在 <code>packages/vchart/src/region</code>    </p>
<p>区域模块负责:    </p>
<ul>
<li>
<p>确定图表中各个子区域的位置和大小    </p>
</li>
<li>
<p>管理其中包含的系列    </p>
</li>
<li>
<p>处理区域之间的布局关系    </p>
</li>
</ul>
<h4 id="component">组件模块 (Component)</h4>
<p>组件是图表中除了数据图形外的辅助元素，如坐标轴、图例、标题等。<code>packages/vchart/src/component</code> 目录下有各种组件实现    </p>
<p>组件模块负责:    </p>
<ul>
<li>
<p>渲染各种辅助元素    </p>
</li>
<li>
<p>与用户交互（如图例的点击）    </p>
</li>
<li>
<p>与主图表的协同工作    </p>
</li>
</ul>
<h4 id="layout">布局模块 (Layout)</h4>
<p>布局模块负责计算图表各个元素的位置和大小。对应代码在 <code>packages/vchart/src/layout</code>具体包括：    </p>
<ul>
<li>
<p>元素位置的计算    </p>
</li>
<li>
<p>自适应容器大小的调整    </p>
</li>
<li>
<p>处理元素之间的层级关系    </p>
</li>
</ul>
<h4 id="event">事件模块 (Event)</h4>
<p>事件模块处理用户交互和内部事件。具体包括：    </p>
<ul>
<li>
<p>处理用户交互事件（如点击、hover）    </p>
</li>
<li>
<p>分发内部事件    </p>
</li>
<li>
<p>触发数据更新和渲染更新    </p>
</li>
</ul>
<h4 id="scale">缩放模块 (Scale)</h4>
<p>缩放模块负责数据到视觉属性的映射转换。具体包括：    </p>
<ul>
<li>
<p>处理数据与视觉空间的映射    </p>
</li>
<li>
<p>管理各种比例尺（线性、离散、颜色等）    </p>
</li>
<li>
<p>计算坐标轴的范围和刻度    </p>
</li>
</ul>
<h4 id="data">数据模块 (Data)</h4>
<p>数据模块处理原始数据的转换和处理。具体包括：    </p>
<ul>
<li>
<p>数据的解析和转换    </p>
</li>
<li>
<p>统计计算    </p>
</li>
<li>
<p>处理缺失值和异常值    </p>
</li>
</ul>
<h2 id="_7">渲染流程</h2>
<p>VChart 的渲染流程主要包括以下步骤：    </p>
<ol>
<li>
<p>初始化: 通过 spec 配置创建 VChart 实例    </p>
</li>
<li>
<p>编译: 解析配置，创建各种组件和系列    </p>
</li>
<li>
<p>布局: 计算各元素的位置和大小    </p>
</li>
<li>
<p>数据处理: 处理和转换数据    </p>
</li>
<li>
<p>渲染准备: 绑定数据到标记    </p>
</li>
<li>
<p>实际渲染: 将标记绘制到画布    </p>
</li>
<li>
<p>交互绑定: 绑定各种交互事件    </p>
</li>
</ol>
<h2 id="_8">数据更新流程</h2>
<p>当数据或配置发生变化时：    </p>
<ol>
<li>
<p>调用 updateData 或 updateSpec 方法    </p>
</li>
<li>
<p>重新处理受影响的数据    </p>
</li>
<li>
<p>更新相关比例尺    </p>
</li>
<li>
<p>重新布局（如果需要）    </p>
</li>
<li>
<p>更新受影响的标记    </p>
</li>
<li>
<p>触发重新渲染    </p>
</li>
</ol>
<p># 本文档由以下人员修正整理 
 <a href="https://github.com/xuanhun">玄魂</a></p>
</body>
</html>