<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4.4 VTable State Management Types</title>
    <meta name="keywords" content="VisActor,VChart,VTable,VStrory,VMind,VGrammar,VRender,Visualization,Chart,Data,Table,Graph,Gis,LLM">
    <style>
        body {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            color: #24292e;
            background-color: #fff;
        }
        h1, h2, h3, h4, h5, h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }
        h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h3 { font-size: 1.25em; }
        code {
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        }
        pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 6px;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            font-size: 100%;
        }
        img {
            max-width: 100%;
            height: auto;
            box-sizing: content-box;
            background-color: #fff;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
            display: block;
            overflow: auto;
        }
        table th, table td {
            padding: 6px 13px;
            border: 1px solid #d0d7de;
        }
        table th {
            font-weight: 600;
            background-color: #f6f8fa;
        }
        table tr {
            background-color: #fff;
            border-top: 1px solid #d0d7de;
        }
        table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }
        a {
            color: #0969da;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        blockquote {
            padding: 0 1em;
            color: #656d76;
            border-left: 0.25em solid #d0d7de;
            margin: 0 0 16px 0;
        }
        hr {
            height: 0.25em;
            padding: 0;
            margin: 24px 0;
            background-color: #d0d7de;
            border: 0;
        }
        ul, ol {
            padding-left: 2em;
        }
        li + li {
            margin-top: 0.25em;
        }
    </style>
</head>
<body>
    <h2 id="introduction">Introduction</h2>
<p>This article will introduce the state management module of VTable, as well as the types of management maintained within the management module.    </p>
<h2 id="state-management-module">State Management Module</h2>
<p>The status module <code>StateManager</code> is responsible for managing the states of various interactions in the table, including selected cells, hover highlight effects, menu display effects, etc.</p>
<p><code>StateManager</code> not only maintains the values of various states, but also defines methods to update each state. When the corresponding event is triggered, it will update the corresponding state. When the state changes, it will update the scene tree and re-render the chart.</p>
<p>Let's focus on what states are maintained in <code>StateManager</code> and the application scenarios of different types of states.    </p>
<h2 id="status-type-enumeration">Status Type Enumeration</h2>
<div style="padding:5px;background-color: rgb(255, 245, 235);border-color: rgb(255, 245, 235);">About the enumeration of state types, located in packages\vtable\src\state\state.ts</div>
</div>
<h3 id="interactionstate">interactionState</h3>
<pre class="codehilite"><code class="language-xml">interactionState: InteractionState; // 主交互状态
interactionStateBeforeScroll?: InteractionState; // 滚动前状态缓存    
</code></pre>

<p><code>interactionState</code> represents the current interaction state of the table, and there are currently three states.    </p>
<ul>
<li>
<p>default     // Default idle state    </p>
</li>
<li>
<p>grabing   // Dragging    \r</p>
</li>
<li>
<p>scrolling // 滚动中    \r</p>
</li>
</ul>
<p>By distinguishing <code>interactionState</code>, conflicts in the interactive state of the table can be avoided.    </p>
<h3 id="select-cell-selection">select Cell Selection</h3>
<pre class="codehilite"><code class="language-xml">select: {
  ranges: (CellRange &amp; { skipBodyMerge?: boolean })[]; // 多选区范围
  highlightScope: HighlightScope; // 高亮模式（单格/整行/整列/十字）
  cellPos: CellPosition;          // 当前聚焦单元格
  disableHeader?: boolean;        // 禁用表头选中
  disableCtrlMultiSelect?: boolean; // 禁用Ctrl多选
  headerSelectMode?: 'inline' | 'cell' | 'body'; // 表头选择模式
  highlightInRange?: boolean;    // 范围内高亮
  selecting: boolean;             // 正在选择中标识
  customSelectRanges?: {          // 自定义样式选区
    range: CellRange;
    style: CustomSelectionStyle;
  }[];
}    
</code></pre>

<p><code>select</code> state maintains the position of the currently selected cell and the configuration of select interactions, including highlightInRange, disableHeader, headerSelectMode, etc.</p>
<h3 id="fillhandle">fillHandle</h3>
<pre class="codehilite"><code class="language-xml">fillHandle: {
  direction?: 'top' | 'bottom' | 'left' | 'right'; // 拖拽方向
  directionRow?: boolean;         // 是否以行方向填充
  isFilling: boolean;             // 正在填充标识
  startX: number;                 // 起始X坐标
  startY: number;                 // 起始Y坐标
  beforeFillMinCol?: number;      // 填充前选区最小列
  beforeFillMinRow?: number;      // 填充前选区最小行
  beforeFillMaxCol?: number;      // 填充前选区最大列
  beforeFillMaxRow?: number;      // 填充前选区最大行
}    
</code></pre>

<p><code>fillHandle</code> mainly maintains the state of the fill handle, used to identify the current fill direction and starting position, etc.</p>
<h3 id="hover">hover</h3>
<pre class="codehilite"><code class="language-xml">hover: {
  highlightScope: HighlightScope; // 悬停高亮模式
  disableHeader?: boolean;        // 禁用表头悬停
  cellPos: CellPosition;          // 当前 hover 位置
  cellPosContainHeader?: CellPosition; *// 记录当前hover的位置(在disableHeader时启用，记录真实位置)*
}    
</code></pre>

<p><code>hover</code> maintains the current mouse hover cell position, as well as <code>hover</code> related configurations: <code>highlightScope</code>, <code>disableHeader</code>.    </p>
<h3 id="columnresize">columnResize</h3>
<pre class="codehilite"><code class="language-xml">columnResize: {
  col: number;        // 调整列索引
  x: number;          // 相对表格X坐标
  resizing: boolean;  // 调整列宽中的标记
  isRightFrozen?: boolean; // 是否右侧冻结列
}
</code></pre>

<p><code>columnResize</code> maintains the state of dragging to adjust column width, the <code>resizing</code> field indicates whether it is currently in the state of dragging to adjust column width, and <code>col</code> records the index of the column currently being adjusted.</p>
<h3 id="rowresize">rowResize</h3>
<pre class="codehilite"><code class="language-Typescript">rowResize: {
  row: number; // 调整行索引
  */** y坐标是相对table内坐标 */*
  y: number; // 相对表格y坐标
  resizing: boolean;  // 调整行高中的标记
  isBottomFrozen?: boolean; // 是否底部冻结列
};    
</code></pre>

<p>Relatively, <code>rowResize</code> records the state of dragging to adjust the row height, <code>row</code> is the index of the current row, and <code>y</code> is the y-coordinate of the current drag position relative to the table.    </p>
<h3 id="columnmove">columnMove</h3>
<pre class="codehilite"><code class="language-Typescript">columnMove: {
  colSource: number;  // 原始列索引
  colTarget: number;  // 目标列索引
  rowSource: number;  // 原始行索引
  rowTarget: number;  // 目标行索引
  x: number;          // 当前X坐标
  y: number;          // 当前Y坐标
  moving: boolean;    // 移动进行中标识
}    
</code></pre>

<p>The state of dragging and swapping columns is maintained in <code>columnRemove</code>, which internally records the current mouse coordinates, as well as the information of the starting row/column and the target row/column.    </p>
<h3 id="menu">menu</h3>
<pre class="codehilite"><code class="language-xml">menu: {
  x: number;           // 菜单显示X坐标
  y: number;           // 菜单显示Y坐标
  isShow: boolean;     // 显示状态
  itemList: MenuListItem[]; // 菜单项列表
  bounds: Bounds;      // 菜单边界范围
  highlightIndex: number; // 高亮项索引
  dropDownMenuHighlight?: DropDownMenuHighlightInfo[]; // 子菜单高亮
}    
</code></pre>

<p><code>menu</code> is responsible for the information of the dropdown menu, maintaining information such as the menu display coordinates, display status, menu items, and highlighted submenu configuration.    </p>
<h3 id="sort">sort</h3>
<pre class="codehilite"><code class="language-xml">sort: Array&lt;{         // 多列排序状态
  col: number;        // 排序列索引
  row: number;        // 排序列表头的行索引
  field?: string;     // 排序字段
  order: SortOrder;   // 排序方向
  icon?: Icon;        // 排序图标
}&gt;;
</code></pre>

<p>The built-in sorting state of VTable is maintained by <code>sort</code>. Since VTable supports multi-column sorting, this configuration is an array. It is responsible for storing which columns are currently sorted, as well as saving information about the sorting icon and sorting direction.</p>
<h3 id="frozen">frozen</h3>
<pre class="codehilite"><code class="language-Typescript">frozen: {             // 冻结状态
  col: number;        // 冻结列截止索引
  icon?: Icon;        // 冻结操作图标
};    
</code></pre>

<p>The information of frozen columns is maintained in <code>frozen</code>, and only the number of columns frozen by this configuration <code>frozenColCount</code> will be saved. When the number of columns changes, the scene tree will be updated.    </p>
<h3 id="scroll">scroll</h3>
<pre class="codehilite"><code class="language-xml">scroll: {
  horizontalBarPos: number; // 水平滚动条滑块位置（像素）
  verticalBarPos: number;   // 垂直滚动条滑块位置（像素）
};    
</code></pre>

<p><code>scroll</code> is mainly responsible for the following two things:    </p>
<ul>
<li>
<p>Record the real-time position of the scrollbar    \r</p>
</li>
<li>
<p>Link with virtual scrolling to calculate the visible area    </p>
</li>
</ul>
<h3 id="drill">drill</h3>
<pre class="codehilite"><code class="language-xml">drill: {
  dimensionKey?: string;  // 当前钻取维度字段
  title?: string;         // 钻取路径显示标题
  drillDown?: boolean;    // 是否下钻状态
  drillUp?: boolean;      // 是否上钻状态
  col: number;            // 触发钻取的列坐标
  row: number;           // 触发钻取的行坐标
};    
</code></pre>

<p>Pivot tables support roll-up and drill-down operations. Information about the current drill-down is mainly maintained in the <code>drill</code> field, including the dimension fields currently drilled and the title displayed for the drill-down.</p>
<h3 id="sparkline">sparkLine</h3>
<pre class="codehilite"><code class="language-xml">sparkLine: {
  col: number; // 当前hover的迷你图列坐标
  row: number; // 当前hover的迷你图行坐标
};    
</code></pre>

<p><code>sparkline</code> stores the row and column values when hovering over the mini chart, making it easy to clear the highlight state of the Sparkline when the mouse moves to other cells.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The state module in VTable has multiple management types, such as the state of selected cells, hover state, etc.</p>
<p>By extracting all the states of the table and maintaining them in one place, the coupling between different modules can be reduced.    </p>
<p>Break down the interaction into state modules, event modules, and rendering modules, establishing a process where events drive states and states drive rendering. This will also make it clearer to organize logic when maintaining and adding new features in the future.    \r</p>
<h1 id="this-document-is-provided-by-the-following-personnel">This document is provided by the following personnel</h1>
<p>taiiiyang（https://github.com/taiiiyang）    </p>
<h1 id="this-document-was-revised-and-organized-by-the-following-personnel">This document was revised and organized by the following personnel</h1>
<p><a href="https://github.com/xuanhun">玄魂</a></p>
</body>
</html>